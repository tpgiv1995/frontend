<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Census Agent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root {
      --bg: #0a3255;
      --card: #0f1621;
      --muted: #94a3b8;
      --line: #1f2937;
      --text: #e7edf3;
      --cta: #2563eb;
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    header { padding: 16px; border-bottom: 1px solid var(--line); display:flex; justify-content:center; }
    main { display: flex; flex-direction: column; gap: 12px; align-items: center; padding: 16px; }
    .wrap { width: 100%; max-width: 1100px; }
    .uploader {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
    }
    .uploader-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .uploader-col {
      min-width: 260px;
      flex: 1 1 260px;
    }
    .uploader label { display: block; font-size: 12px; color: #cbd5e1; }
    .uploader input[type=file] {
      width: 100%;
      margin-top: 4px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: var(--bg);
      color: var(--text);
    }
    .uploader .title { font-weight: 600; margin-bottom: 4px; }
    .uploader .sub { font-size: 12px; color: var(--muted); }
    .actions { display: flex; gap: 8px; align-items: center; }
    .btn {
      background: var(--cta);
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      white-space: nowrap;
    }
    .hint { font-size: 12px; color: var(--muted); }
    /* Chat widget */
    openai-chatkit {
      width: 430px;
      height: 720px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #0b0f14;
    }
    /* Make widget expand a bit on larger screens if you like:
      @media (min-width: 1200px) { openai-chatkit { width: 520px; } }
    */
  </style>
  <!-- Load ChatKit -->
  <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" async></script>
</head>

<body>
  <header><strong>Census Agent</strong></header>

  <main>
    <div class="wrap">
      <!-- Compact horizontal uploader banner -->
      <div id="uploader" class="uploader">
        <div class="uploader-row">
          <div class="uploader-col">
            <div class="title">Upload files to begin</div>
            <div class="sub">
              Choose <b>source census</b> and <b>carrier template</b> then click <b>Start</b>.
              (Or use the <b>paperclip</b> inside chat.)
            </div>
          </div>

          <div class="uploader-col">
            <label>Source census
              <input id="src" type="file" accept=".csv,.xlsx,.xls,.txt">
            </label>
          </div>

          <div class="uploader-col">
            <label>Carrier template
              <input id="tpl" type="file" accept=".csv,.xlsx,.xls,.txt">
            </label>
          </div>

          <div class="actions">
            <button id="startBtn" class="btn">Start</button>
            <span id="hint" class="hint"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat widget -->
    <openai-chatkit id="census-chat"></openai-chatkit>
  </main>

  <script type="module">
    const API_BASE = "https://census-api-uyfo.onrender.com";

    // DOM elements
    const srcEl = document.getElementById("src");
    const tplEl = document.getElementById("tpl");
    const startBtn = document.getElementById("startBtn");
    const hintEl = document.getElementById("hint");
    const chatEl = document.getElementById("census-chat");

    // If banner files exist, use them; otherwise prompt for two files
    async function getBannerFilesOrPick() {
      if (srcEl?.files?.[0] && tplEl?.files?.[0]) {
        return [srcEl.files[0], tplEl.files[0]];
      }
      return new Promise((resolve, reject) => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".csv,.xlsx,.xls,.txt";
        input.multiple = true;
        input.onchange = () => {
          const files = Array.from(input.files || []);
          if (files.length !== 2) reject(new Error("Please select exactly TWO files: source + template."));
          else resolve(files);
        };
        input.click();
      });
    }

    // The Start button: guide user + prep files; agent will call the tool
    startBtn.onclick = async () => {
      const src = srcEl?.files?.[0], tpl = tplEl?.files?.[0];
      if (!src || !tpl) {
        hintEl.textContent = "Please select BOTH files first.";
        return;
      }
      hintEl.textContent = "Starting… click the chat input and press Enter if it doesn't move in 2s.";
      chatEl?.scrollIntoView({ behavior: "smooth", block: "start" });
      setTimeout(() => {
        if (hintEl.textContent.startsWith("Starting…")) {
          hintEl.textContent = "If nothing appears, click the chat input and press Enter to begin.";
        }
      }, 1500);
    };

    // Basic fallback picker (used only if banner files aren’t provided)
    function pickTwoFiles(accept = ".csv,.xlsx,.xls,.txt") {
      return new Promise((resolve, reject) => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = accept;
        input.multiple = true;
        input.onchange = () => {
          const files = Array.from(input.files || []);
          if (files.length !== 2) reject(new Error("Please select exactly TWO files: source + template."));
          else resolve(files);
        };
        input.click();
      });
    }

    let sessionId = null;

    async function getClientSecret() {
      const r = await fetch(`${API_BASE}/api/chatkit/session`, { method: "POST" });
      if (!r.ok) throw new Error(`chatkit session failed: ${r.status} ${r.statusText}`);
      const j = await r.json();
      if (!j.client_secret) throw new Error("No client_secret in response");
      return j.client_secret;
    }

    customElements.whenDefined('openai-chatkit').then(() => {
      const chat = document.getElementById("census-chat");

      chat.setOptions({
        api: {
          async getClientSecret(existing) {
            return getClientSecret();
          }
        },

        async onClientTool({ name, params }) {
          switch (name) {
            case "start_census_session": {
              // Prefer pre-selected banner files; otherwise fall back to picker
              let source, template;
              if (srcEl?.files?.[0] && tplEl?.files?.[0]) {
                source = srcEl.files[0];
                template = tplEl.files[0];
              } else {
                const picked = await pickTwoFiles();
                [source, template] = picked;
              }

              const fd = new FormData();
              fd.append("source_file", source);
              fd.append("template_file", template);

              const r = await fetch(`${API_BASE}/agent/start`, { method: "POST", body: fd });
              if (!r.ok) throw new Error(`/agent/start failed: ${r.status} ${r.statusText}`);
              const j = await r.json();

              // Clear banner hint now that session exists
              if (hintEl) hintEl.textContent = "";

              // Save session for later agent_turn calls
              sessionId = j.session_id;
              return { session_id: j.session_id };
            }

            case "agent_turn": {
              if (!sessionId) throw new Error("No active session. Call start_census_session() first.");
              const body = { session_id: sessionId, text: String(params?.text ?? "") };
              const r = await fetch(`${API_BASE}/agent/message_json`, {
                method: "POST",
                headers: { "Content-Type":"application/json" },
                body: JSON.stringify(body)
              });
              const raw = await r.text();
              let j; try { j = JSON.parse(raw); }
              catch { throw new Error(`Non-JSON from /agent/message_json: ${raw.slice(0,200)}`); }
              if (j.session_id) sessionId = j.session_id;
              return j; // includes { text, preview?, download_url? }
            }

            case "open_export": {
              const url = params?.url;
              if (!url) throw new Error("Missing url");
              const href = url.startsWith("http") ? url : `${API_BASE}${url}`;
              window.open(href, "_blank", "noopener");
              return {};
            }

            default:
              throw new Error(`Unhandled client tool: ${name}`);
          }
        }
      });
    });
  </script>
</body>
</html>

