<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Census Agent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin:0; background:#0b0f14; color:#e7edf3; }
    header { padding:16px; border-bottom:1px solid #1f2937; }
    main { display:flex; justify-content:center; padding:16px; }
    openai-chatkit { width: 430px; height: 720px; border:1px solid #1f2937; border-radius:12px; }
  </style>
  <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" async></script>
</head>
<body>
  <header><strong>Census Agent</strong></header>
  <main>
    <openai-chatkit id="census-chat"></openai-chatkit>
  </main>
  <script type="module">
    // Point this to your Render API base
    const API_BASE = "https://census-api-uyfo.onrender.com";
    const chat = document.getElementById("census-chat");

    function pickTwoFiles(accept = ".csv,.xlsx,.xls,.txt") {
      return new Promise((resolve, reject) => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = accept;
        input.multiple = true;
        input.onchange = () => {
          const files = Array.from(input.files || []);
          if (files.length !== 2) reject(new Error("Please select exactly TWO files: source + template."));
          else resolve(files);
        };
        input.click();
      });
    }

    let sessionId = null;

    async function getClientSecret() {
      const r = await fetch(`${API_BASE}/api/chatkit/session`, { method: "POST" });
      if (!r.ok) throw new Error(`chatkit session failed: ${r.status} ${r.statusText}`);
      const j = await r.json();
      if (!j.client_secret) throw new Error("No client_secret in response");
      return j.client_secret;
    }

    chat.setOptions({
      api: {
        async getClientSecret(existing) { return getClientSecret(); }
      },
      async onClientTool({ name, params }) {
        switch (name) {
          case "start_census_session": {
            const [source, template] = await pickTwoFiles();
            const fd = new FormData();
            fd.append("source_file", source);
            fd.append("template_file", template);
            const r = await fetch(`${API_BASE}/agent/start`, { method:"POST", body: fd });
            if (!r.ok) throw new Error(`/agent/start failed: ${r.status} ${r.statusText}`);
            const j = await r.json();
            sessionId = j.session_id;
            return { session_id: sessionId };
          }
          case "agent_turn": {
            if (!sessionId) throw new Error("No active session. Call start_census_session() first.");
            const body = { session_id: sessionId, text: String(params?.text ?? "") };
            const r = await fetch(`${API_BASE}/agent/message_json`, {
              method:"POST",
              headers: { "Content-Type":"application/json" },
              body: JSON.stringify(body)
            });
            const raw = await r.text();
            let j; try { j = JSON.parse(raw); } catch { throw new Error(`Non-JSON from /agent/message_json: ${raw.slice(0,200)}`); }
            if (j.session_id) sessionId = j.session_id;  // keep in sync
            return j; // { text, preview?, download_url? }
          }
          case "open_export": {
            const url = params?.url;
            if (!url) throw new Error("Missing url");
            const href = url.startsWith("http") ? url : `${API_BASE}${url}`;
            window.open(href, "_blank", "noopener");
            return {};
          }
          default:
            throw new Error(`Unhandled client tool: ${name}`);
        }
      }
    });
  </script>
</body>
</html>
