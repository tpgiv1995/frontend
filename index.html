<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Census Agent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <style>
    :root{
      --bg:#0b0f14; --card:#0f1621; --muted:#94a3b8; --line:#1f2937; --text:#e7edf3; --cta:#2563eb;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui, Arial, sans-serif; background:var(--bg); color:var(--text)}
    header{padding:16px; border-bottom:1px solid var(--line); display:flex; justify-content:center}
    .page{max-width:1280px; margin:0 auto; padding:16px}
    .layout{display:grid; grid-template-columns: 320px 1fr; gap:16px}
    @media (max-width: 980px){ .layout{grid-template-columns: 1fr; } }

    /* Uploader */
    .card{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px}
    .title{font-weight:600; margin-bottom:4px}
    .sub{font-size:12px; color:var(--muted); margin-bottom:10px}
    label{display:block; font-size:12px; color:#cbd5e1; margin:8px 0 4px}
    input[type=file]{width:100%; padding:8px; border-radius:8px; border:1px solid var(--line); background:var(--bg); color:var(--text)}
    .row{display:flex; align-items:center; gap:8px; margin-top:10px}
    .btn{background:var(--cta); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer}
    .hint{font-size:12px; color:var(--muted)}
    .mini{font-size:11px; color:var(--muted); margin-top:8px; line-height:1.35}

    /* Chat */
    .chatwrap{height: calc(100vh - 140px); min-height: 640px}
    openai-chatkit{
      width:100%; height:100%;
      border:1px solid var(--line); border-radius:12px; background: #0b0f14;
    }
  </style>

  <!-- Load ChatKit -->
  <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" async></script>
</head>

<body>
  <header><strong>Census Agent</strong></header>

  <div class="page">
    <div class="layout">
      <!-- Left: compact uploader sidebar -->
      <aside class="card">
        <div class="title">Upload files to begin</div>
        <div class="sub">
          Choose <b>source census</b> and <b>carrier template</b>, then click <b>Start</b>.
          (You can also attach files via the <b>paperclip</b> in chat.)
        </div>

        <label>Source census</label>
        <input id="src" type="file" accept=".csv,.xlsx,.xls,.txt">

        <label>Carrier template</label>
        <input id="tpl" type="file" accept=".csv,.xlsx,.xls,.txt">

        <div class="row">
          <button id="startBtn" class="btn">Start</button>
          <span id="hint" class="hint"></span>
        </div>

        <div class="mini">
          Tip: If the assistant doesn't move right away, click the chat box and press <b>Enter</b> once to begin.
        </div>
      </aside>

      <!-- Right: wide chat -->
      <section class="chatwrap">
        <openai-chatkit id="census-chat"></openai-chatkit>
      </section>
    </div>
  </div>

  <script type="module">
    const API_BASE = "https://census-api-uyfo.onrender.com";

    // Elements
    const srcEl  = document.getElementById("src");
    const tplEl  = document.getElementById("tpl");
    const startBtn = document.getElementById("startBtn");
    const hintEl   = document.getElementById("hint");
    const chatEl   = document.getElementById("census-chat");

    // Banner helper: use preselected files if available; otherwise prompt for two
    function pickTwoFiles(accept = ".csv,.xlsx,.xls,.txt"){
      return new Promise((resolve,reject)=>{
        const input = document.createElement("input");
        input.type = "file"; input.accept = accept; input.multiple = true;
        input.onchange = () => {
          const files = Array.from(input.files || []);
          if (files.length !== 2) reject(new Error("Please select exactly TWO files: source + template."));
          else resolve(files);
        };
        input.click();
      });
    }

    async function getBannerFilesOrPick(){
      if (srcEl?.files?.[0] && tplEl?.files?.[0]) {
        return [srcEl.files[0], tplEl.files[0]];
      }
      return pickTwoFiles();
    }

    // Start button UX nudge
    startBtn.onclick = () => {
      if (!srcEl?.files?.[0] || !tplEl?.files?.[0]) {
        hintEl.textContent = "Please select BOTH files first.";
        return;
      }
      hintEl.textContent = "Starting… if it stalls, click the chat input and press Enter to begin.";
      chatEl?.scrollIntoView({ behavior: "smooth", block: "start" });
    };

    // ChatKit auth
    async function getClientSecret(){
      const r = await fetch(`${API_BASE}/api/chatkit/session`, { method:"POST" });
      if (!r.ok) throw new Error(`chatkit session failed: ${r.status} ${r.statusText}`);
      const j = await r.json();
      if (!j.client_secret) throw new Error("No client_secret in response");
      return j.client_secret;
    }

    let sessionId = null;

    // Ensure component is registered before configuring
    customElements.whenDefined('openai-chatkit').then(() => {
      const chat = document.getElementById("census-chat");

      chat.setOptions({
        api: {
          async getClientSecret(existing) {
            return getClientSecret();
          }
        },

        async onClientTool({ name, params }) {
          switch (name) {
            // Agent requests two files – we provide from banner if available
            case "start_census_session": {
              let source, template;
              if (srcEl?.files?.[0] && tplEl?.files?.[0]) {
                source = srcEl.files[0];
                template = tplEl.files[0];
              } else {
                const picked = await getBannerFilesOrPick();
                [source, template] = picked;
              }

              const fd = new FormData();
              fd.append("source_file", source);
              fd.append("template_file", template);

              const r = await fetch(`${API_BASE}/agent/start`, { method:"POST", body: fd });
              if (!r.ok) throw new Error(`/agent/start failed: ${r.status} ${r.statusText}`);
              const j = await r.json();

              // Save session for later message turns
              sessionId = j.session_id;
              if (hintEl) hintEl.textContent = "";

              return { session_id: j.session_id };
            }

            // Normal turn routing to your backend
            case "agent_turn": {
              if (!sessionId) throw new Error("No active session. Call start_census_session() first.");
              const body = { session_id: sessionId, text: String(params?.text ?? "") };

              const r = await fetch(`${API_BASE}/agent/message_json`, {
                method:"POST",
                headers: { "Content-Type":"application/json" },
                body: JSON.stringify(body)
              });

              const raw = await r.text();
              let j;
              try { j = JSON.parse(raw); }
              catch { throw new Error(`Non-JSON from /agent/message_json: ${raw.slice(0,200)}`); }

              if (j.session_id) sessionId = j.session_id;
              return j; // { text, preview?, download_url? }
            }

            // Open final export link
            case "open_export": {
              const url = params?.url;
              if (!url) throw new Error("Missing url");
              const href = url.startsWith("http") ? url : `${API_BASE}${url}`;
              window.open(href, "_blank", "noopener");
              return {};
            }

            default:
              throw new Error(`Unhandled client tool: ${name}`);
          }
        }
      });
    });
  </script>
</body>
</html>
